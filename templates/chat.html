<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Atharva College AI Chatbot</title>
  <link rel="stylesheet" href="/static/style.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="background-overlay"></div>
  <div class="container d-flex justify-content-center align-items-center min-vh-100">
    <div class="chat-container">
      <div class="chat-header">
        <div class="header-content">
          <div class="logo-section">
            <div class="logo-icon">
              <i class="fas fa-graduation-cap"></i>
            </div>
            <div class="header-text">
              <h2 class="chat-title">Atharva College AI</h2>
              <p class="chat-subtitle">Your intelligent campus assistant</p>
            </div>
          </div>
          <div class="status-indicator">
            <div class="status-dot"></div>
            <span class="status-text">Online</span>
          </div>
        </div>
      </div>
      
      <div class="chat-messages" id="chat-box">
        <div class="welcome-message">
          <div class="bot-avatar">
            <i class="fas fa-robot"></i>
          </div>
          <div class="welcome-text">
            <p>ðŸ‘‹ Welcome to Atharva College AI Assistant!</p>
            <p>I'm here to help you with college-related questions, admissions, courses, fees, and more.</p>
          </div>
        </div>
      </div>
      
      <div class="chat-input-container">
        <form id="chat-form" method="POST" class="chat-form">
          <div class="input-wrapper">
            <input type="text" id="user-input" name="msg" class="chat-input" placeholder="Ask me anything about Atharva College..." autocomplete="off" required />
            <button type="submit" class="send-button" id="send-btn">
              <i class="fas fa-paper-plane"></i>
            </button>
            <button type="button" class="stop-button" id="stop-btn" style="display: none;">
              <i class="fas fa-stop"></i>
            </button>
          </div>
        </form>
        <div class="input-suggestions">
          <button class="suggestion-chip" onclick="setSuggestion('who is the chairman?')">
            Who is the Chairman?
          </button>
          <button class="suggestion-chip" onclick="setSuggestion('What are the educational qualifications to be eligible?')">
            What are the educational qualifications to be eligible?
          </button>
          <button class="suggestion-chip" onclick="setSuggestion('What courses are available?')">
            Available Courses
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const chatForm = document.getElementById('chat-form');
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const stopBtn = document.getElementById('stop-btn');
    
    let currentRequest = null;
    let isGenerating = false;

    // Function to set suggestion in input
    function setSuggestion(text) {
      userInput.value = text;
      userInput.focus();
    }

    // Function to toggle buttons
    function toggleButtons(generating) {
      isGenerating = generating;
      if (generating) {
        sendBtn.style.display = 'none';
        stopBtn.style.display = 'flex';
        userInput.disabled = true;
      } else {
        sendBtn.style.display = 'flex';
        stopBtn.style.display = 'none';
        userInput.disabled = false;
      }
    }

    // Stop button functionality
    stopBtn.addEventListener('click', () => {
      if (currentRequest) {
        currentRequest.abort();
        currentRequest = null;
      }
      
      // Remove typing indicator if present
      const typingIndicator = document.querySelector('.typing-indicator');
      if (typingIndicator) {
        typingIndicator.remove();
      }
      
      // Add stopped message
      const stoppedDiv = document.createElement('div');
      stoppedDiv.className = 'message-container bot-message stopped-message';
      stoppedDiv.innerHTML = `
        <div class="message-avatar">
          <i class="fas fa-hand-paper"></i>
        </div>
        <div class="message-content">
          <div class="message-text">Response stopped by user.</div>
          <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        </div>
      `;
      chatBox.appendChild(stoppedDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
      
      toggleButtons(false);
    });

    // Add typing animation
    function showTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'message-container bot-message typing-indicator';
      typingDiv.innerHTML = `
        <div class="message-avatar">
          <i class="fas fa-robot"></i>
        </div>
        <div class="message-content">
          <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      `;
      chatBox.appendChild(typingDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
      return typingDiv;
    }

    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const userMessage = userInput.value.trim();
      if (!userMessage || isGenerating) return;

      // Add user message
      const userMessageDiv = document.createElement('div');
      userMessageDiv.className = 'message-container user-message';
      userMessageDiv.innerHTML = `
        <div class="message-content">
          <div class="message-text">${userMessage}</div>
          <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        </div>
        <div class="message-avatar">
          <i class="fas fa-user"></i>
        </div>
      `;
      chatBox.appendChild(userMessageDiv);

      userInput.value = '';
      toggleButtons(true);

      // Show typing indicator
      const typingIndicator = showTypingIndicator();

      // Create AbortController for this request
      const controller = new AbortController();
      currentRequest = controller;

      try {
        const response = await fetch('/get', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({ msg: userMessage }),
          signal: controller.signal
        });

        const botMessage = await response.text();

        // Remove typing indicator
        if (typingIndicator.parentNode) {
          typingIndicator.remove();
        }

        // Add bot message
        const botMessageDiv = document.createElement('div');
        botMessageDiv.className = 'message-container bot-message';
        botMessageDiv.innerHTML = `
          <div class="message-avatar">
            <i class="fas fa-robot"></i>
          </div>
          <div class="message-content">
            <div class="message-text">${botMessage}</div>
            <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
          </div>
        `;
        chatBox.appendChild(botMessageDiv);

      } catch (error) {
        // Remove typing indicator
        if (typingIndicator.parentNode) {
          typingIndicator.remove();
        }
        
        // Only show error if it wasn't aborted
        if (error.name !== 'AbortError') {
          const errorDiv = document.createElement('div');
          errorDiv.className = 'message-container bot-message error-message';
          errorDiv.innerHTML = `
            <div class="message-avatar">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="message-content">
              <div class="message-text">Sorry, I'm having trouble responding right now. Please try again.</div>
            </div>
          `;
          chatBox.appendChild(errorDiv);
        }
      } finally {
        currentRequest = null;
        toggleButtons(false);
      }

      chatBox.scrollTop = chatBox.scrollHeight;
    });

    // Auto-resize input and handle enter key
    userInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatForm.dispatchEvent(new Event('submit'));
      }
    });
  </script>
</body>
</html>
